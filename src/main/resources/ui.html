<html>
    <head>
	<title>LearnPAd WebUI</title>

	<link rel="stylesheet" style="text/css" href="resources/deps/opt/bootstrap.css" />

	<script type="text/javascript" src="resources/deps/jquery.min.js"></script>
	<script type="text/javascript" src="resources/deps/underscore.js"></script>
	<script type="text/javascript" src="resources/lib/jsonform.js"></script>

	<script type="text/javascript">
	 if (!window.WebSocket){
	     alert("WebSocket not supported by this browser");
	 }

	 function TasksReceiver(address) {

	     var finishOnError = false;

	     TasksReceiver.prototype.init = function(uiid) {

		 var location = "ws://" + address + "/ui/" + uiid;
		 taskReceiver._ws = new WebSocket(location);
		 taskReceiver._ws.onopen = this._onopen;
		 taskReceiver._ws.onmessage = this._onmessage;
		 taskReceiver._ws.onclose = this._onclose;
		 taskReceiver._ws.onerror = this._onerror;
	     }

	     TasksReceiver.prototype.finish = function() {
		 $('#finished').removeClass('hidden');
	     }

	     TasksReceiver.prototype._onopen = function() {
		 $('#connect').remove();
	     }

	     TasksReceiver.prototype._onmessage = function(m) {
		 var msg = JSON.parse(m.data);
		 switch(msg.type) {

		     case "FINISHED":
			 taskReceiver.finish();
			 break;

		     case "ADDTASK":
			 var newTask = new Task(address, msg.taskid);
			 activeTasks[msg.taskid] = newTask;
			 newTask.join();
			 break;

		     case "DELTASK":
			 // may be undefined if task was closed from another ui
			 activeTasks[msg.taskid].end();
			 break;
		 }
	     }

	     TasksReceiver.prototype._onclose = function(m) {
		 taskReceiver._ws = null;
		 if(finishOnError){
		     alert("The following error occurred: " + m.reason + " (" + m.code +")");
		 }
	     }

	     TasksReceiver.prototype._onerror = function(e) {
		 finishOnError = true;
	     }
	 }

	 function Task(address, taskid) {
	     var closeOnError = false;

	     Task.prototype.join = function() {
		 var location = "ws://" + address + "/tasks/" + taskid
		 activeTasks[taskid]._ws = new WebSocket(location);
		 activeTasks[taskid]._ws.onopen = this._onopen;
		 activeTasks[taskid]._ws.onmessage = this._onmessage;
		 activeTasks[taskid]._ws.onclose = this._onclose;
		 activeTasks[taskid]._ws.onerror = this._onerror;
	     }

	     Task.prototype.end = function() {
		 activeTasks[taskid]._onclose('');
	     }

	     Task.prototype.send = function(data) {
		 activeTasks[taskid]._ws.send(data);
	     }

	     Task.prototype._onopen = function(){

		 var tasksDiv = $('#tasks');

		 var taskDiv = document.createElement('div');
		 taskDiv.id = 'taskcontainer'+taskid;
		 taskDiv.innerHTML = '<p id="taskdata' + taskid + '"></p>\
	<form id="taskform'+ taskid + '"></form>\
	<hr>';

		 tasksDiv.append(taskDiv);
	     }

	     Task.prototype._onmessage = function(m) {
		 var data = JSON.parse(m.data);

		 $('#taskdata' + taskid).html(data.description);
		 $('#taskform' + taskid).jsonForm({
		     schema: data.form.schema,
		     form: data.form.form,
		     onSubmit: function (errors, values) {
			 if (errors) {
			     alert("error");
			 }
			 else {
			     activeTasks[taskid].send(JSON.stringify(values));
			     return false;
			 }
		     }});
	     }

	     Task.prototype._onclose = function(m) {
		 activeTasks.splice(activeTasks.indexOf(activeTasks[taskid]), 1);

		 $('#taskform' + taskid).remove();
		 $('#taskcontainer' + taskid).addClass('disabled');

		 if(closeOnError){
		     alert("The following error occurred: " + m.reason + " (" + m.code +")");
		 }
	     }

	     Task.prototype._onerror = function(e) {
		 closeOnError = true;
	     }
	 }

	 var activeTasks = [];
	 var taskReceiver = new TasksReceiver(#serveripaddress#);

	</script>

	<style type='text/css'>
	 .hidden {
	     display: none;
	 }
	 .disabled {
	     opacity: 0.5;
	 }
	</style>

    </head>
    <body>

	<form id="connect" class="form-inline">
	    <div class="form-group">
		<label for="uiid">UI Id:&nbsp;</label>
		<input id="uiid" type="text" class="form-control"/>
		<button id="connectBn"
			type="submit" class="btn btn-default">connect</button>
	    </div>
	</form>

	<script type="text/javascript">
	 $('#connectBn').click(function(event) {
	     taskReceiver.init($('#uiid').val());
	     return false;
	 });
	</script>

	<div id="tasks"></div>
	<p id="finished" class="hidden">Process finished.</p>

    </body>
</html>
